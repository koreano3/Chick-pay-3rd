{% extends 'base.html' %}
{% block title %}Chick Pay - ë¡œê·¸ì¸{% endblock %}

{% block content %}
{% load static %}
<div class=" bg-white rounded-3xl shadow-lg p-8 max-w-md w-full border-3 border-chick-yellow">
    <h2 class="text-2xl font-bold text-chick-brown mb-6 text-center">ë¡œê·¸ì¸</h2>

    <form id="login-form">
        {% csrf_token %}
        <div class=" mb-5">
            <label for="email" class="block mb-2 font-semibold text-gray-600">ì´ë©”ì¼ ì•„ì´ë””</label>
            <input type="email" id="email" name="username" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" required
                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
        </div>

        <div class="mb-5">
            <label for="password" class="block mb-2 font-semibold text-gray-600">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required
                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
        </div>

        <button type="submit"
            class="w-full bg-chick-yellow text-chick-brown font-bold py-4 px-6 rounded-xl shadow-md hover:bg-chick-orange transition transform hover:-translate-y-0.5 active:translate-y-0">
            ë¡œê·¸ì¸ <img src="{% static 'images/image.png' %}" alt="Chick Pay" class="w-5 h-5 ml-1 inline">
        </button>

    </form>

    <div class="mt-6 text-center">
        <p class="text-gray-600">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="{% url 'register' %}"
                class="text-chick-brown font-semibold hover:underline">íšŒì›ê°€ì…</a></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("login-form");

        form.addEventListener("submit", async function (e) {
            e.preventDefault();

            const payload = {
                email: document.getElementById("email").value,
                password: document.getElementById("password").value,
            };

            try {
                const response = await fetch("http://127.0.0.1:8001/api/token/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        email: document.getElementById("email").value,
                        password: document.getElementById("password").value,
                    }),
                });

                const result = await response.json();
                console.log(response.status, result);

                if (response.ok) {
                    // JWT í† í° ì €ì¥
                    localStorage.setItem('access', result.access);
                    localStorage.setItem('refresh_token', result.refresh);
                    alert("ğŸ‘ë¡œê·¸ì¸ ì„±ê³µ!");
                    window.location.href = "{% url 'otp-setup' %}";
                } else {
                    let errorMessage = "ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                    if (result.detail) errorMessage = result.detail;
                    alert("â— ë¡œê·¸ì¸ ì‹¤íŒ¨: " + errorMessage);
                }
            } catch (error) {
                console.error("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
                alert("ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        });

        // í† í° ê°±ì‹  í•¨ìˆ˜ ì¶”ê°€
        async function refreshToken() {
            try {
                const refresh_token = localStorage.getItem('refresh_token');
                if (!refresh_token) {
                    throw new Error('No refresh token available');
                }

                const response = await fetch("http://127.0.0.1:8001/zapp/token/refresh/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        refresh: refresh_token
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    return data.access;
                } else {
                    throw new Error('Token refresh failed');
                }
            } catch (error) {
                console.error('Token refresh error:', error);
                // í† í° ê°±ì‹  ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                window.location.href = "{% url 'login' %}";
                return null;
            }
        }

        // API ìš”ì²­ì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜ ì¶”ê°€
        async function fetchWithAuth(url, options = {}) {
            const access_token = localStorage.getItem('access_token');

            if (!access_token) {
                throw new Error('No access token available');
            }

            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${access_token}`,
            };

            try {
                const response = await fetch(url, { ...options, headers });

                if (response.status === 401) {
                    // í† í°ì´ ë§Œë£Œëœ ê²½ìš° ê°±ì‹  ì‹œë„
                    const newToken = await refreshToken();
                    if (newToken) {
                        // ìƒˆë¡œìš´ í† í°ìœ¼ë¡œ ì¬ì‹œë„
                        headers['Authorization'] = `Bearer ${newToken}`;
                        return fetch(url, { ...options, headers });
                    }
                }

                return response;
            } catch (error) {
                console.error('API request error:', error);
                throw error;
            }
        }

        // CSRF í† í° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}