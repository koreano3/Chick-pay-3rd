kind: pipeline
type: docker
name: deploy-for-main


  # 1. ECRì— ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
steps:
@@ -22,6 +23,12 @@
      branch:
        - main
  # 2. ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ 2
  - name: deploy-ecs
@@ -93,11 +100,11 @@
          echo "âœ… ë³´ì•ˆ ë¶„ì„ í†µê³¼: ì‹¬ê°í•œ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."
          fi

#   # 6. ë¶€í•˜ í…ŒìŠ¤íŠ¸ + locust ê²°ê³¼ ì²´í¬ 
  - name: locust-load-test
    image: python:3.11
    environment:
      PGHOST: 
        from_secret: dbhost
      PGUSER: postgres
      PGPASSWORD:
@@ -123,21 +130,21 @@

        echo "ğŸ§ª Locust ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹œì‘"
        locust --headless -f locustfile.py -u 28 -r 5 -t 30s --host https://chick-pay.com --csv=locust_result 
        
        wait 
        
        echo "ğŸ“¤ DB ì»¤ë„¥ì…˜ ë¡œê·¸ ì¶œë ¥ ==============================="
        cat db_conn_log.txt
      - python check_locust_result.py

# # Drone UIì—ì„œ ë¡œê·¸ í™•ì¸í•˜ëŠ” ì»¨í…Œì´ë„ˆ 
  - name: show-locust-csv
    image: python:3.11
    commands:
    - pip install pandas
    - python -c "import pandas as pd; df = pd.read_csv('locust_result_stats.csv'); print('ğŸ“Š LOCUST ê²°ê³¼ =========================='); print(df.to_string())"

# # ë¶€í•˜ í…ŒìŠ¤íŠ¸ í›„ ì»¤ë„¥ì…˜ ëˆ„ìˆ˜ í™•ì¸
  - name: monitor-db-end
    image: postgres:14
    environment:
@@ -164,9 +171,9 @@
          echo "âŒ conn_countê°€ ìˆ«ìê°€ ì•„ë‹˜ â†’ '$conn_count'"
          exit 1
        fi
trigger:
  branch:
    - main
    - feat/drone
    - feat/infra