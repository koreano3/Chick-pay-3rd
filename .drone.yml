kind: pipeline
type: docker
name: deploy-for-main

  # 1. ECRì— ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
steps:
  - name: build-and-push-to-ecr
    image: plugins/ecr
    settings:
      repo: 297195401389.dkr.ecr.ap-northeast-2.amazonaws.com/zapp
      region: ap-northeast-2
      access_key:
        from_secret: aws_access_key_id
      secret_key:
        from_secret: aws_secret_access_key
      tags:
        - latest
        - ${DRONE_COMMIT_SHA}
      dockerfile: dockerfile
      context: .
      when:
        branch:
          - main


  # 2. ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ 2
  - name: deploy-ecs
    image: amazon/aws-cli
    settings:
      access_key:
        from_secret: aws_access_key_id
      secret_key:
        from_secret: aws_secret_access_key
      region: ap-northeast-2
    commands:
      - aws ecs update-service --cluster ChickCluster --service ChickTask-service-DJANGO --force-new-deployment
    when:
      branch:
        - main

  # # 3. ZAP ìë™í™” ìŠ¤ìº”
  # - name: zap-full-automation
  #   image: appleboy/drone-ssh
  #   environment:
  #     ZAP_USERNAME:
  #       from_secret: ZAP_USERNAME
  #     ZAP_PASSWORD:
  #       from_secret: ZAP_PASSWORD
  #   settings:
  #     host:
  #       from_secret: drone_ec2
  #     username: ubuntu
  #     key:
  #       from_secret: drone_ec2_ssh_key
  #     port: 22
  #     script:
  #       - cd /home/ubuntu/zap
  #       - docker run --rm -v $(pwd):/zap/wrk/:rw --memory=1.5g --cpus=2 ghcr.io/zaproxy/zaproxy:stable zap.sh -cmd -autorun /zap/wrk/zap-automation.yaml
  #       - |
  #         echo "ğŸ” JSON ë¦¬í¬íŠ¸ì—ì„œ High ìœ„í—˜ ì´ìƒ ìˆëŠ”ì§€ ê²€ì‚¬ ì¤‘..."
  #         ERRORS=$(jq '[.site[].alerts[].riskcode | tonumber] | map(select(. >= 3)) | length' reports/zap_report.json)
  #         if [ "$ERRORS" -gt 0 ]; then
  #           echo "âŒ High ìœ„í—˜ë„ $ERRORS ê±´ ë°œê²¬ë¨! ë°°í¬ ì¤‘ë‹¨."
  #           exit 1
  #         else
  #           echo "âœ… High ìœ„í—˜ ì—†ìŒ. ê³„ì† ì§„í–‰."
  #         fi

  # # 4. ë‹¨ìœ„/í†µí•© í…ŒìŠ¤íŠ¸
  # - name: pytest
  #   image: python:3.12
  #   environment:
  #     DJANGO_SETTINGS_MODULE: my_project.settings
  #   commands:
  #     - pip install --upgrade pip
  #     - pip install -r requirements.txt
  #     - python manage.py migrate
  #     - pytest

  # # 5. Bandit ì •ì  ë¶„ì„
  # - name: bandit-analysis
  #   image: python:3.12
  #   commands:
  #     - apt-get update && apt-get install -y jq
  #     - pip install bandit
  #     - bandit -r core zapp my_project -f json -o analysis/bandit-report.json -x zapp/tests
  #     - |
  #       ERRORS=$(jq '.metrics._totals.high + .metrics._totals.medium' analysis/bandit-report.json)
  #       if [ "$ERRORS" -gt 0 ]; then
  #         echo "âŒ ë°°í¬ ì¤‘ë‹¨: ë³´ì•ˆ ì·¨ì•½ì ì´ ${ERRORS}ê±´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
  #         exit 1
  #       else
  #         echo "âœ… ë³´ì•ˆ ë¶„ì„ í†µê³¼: ì‹¬ê°í•œ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."
  #         fi

  # 6. ë¶€í•˜ í…ŒìŠ¤íŠ¸
  - name: locust-load-test
    image: python:3.11
    commands:
      - pip install locust pandas pyotp
      - locust --headless -f locustfile.py -u 200 -r 20 -t 3m --host https://chick-pay.com --csv=locust_result
      - python check_locust_result.py

# 9. Locust ê²°ê³¼ ì²´í¬
  - name: check-locust-result
    image: python:3.11
    commands:
      

  # 7. CloudWatch ëª¨ë‹ˆí„°ë§
  - name: monitor-cloudwatch
    image: amazon/aws-cli
    commands:
      - aws cloudwatch get-metric-statistics \
        --namespace AWS/EC2 \
        --metric-name CPUUtilization \
        --dimensions Name=InstanceId,Value=i-0b2440e7ffbc23f5a \
        --start-time $(date -u -d '-10 minutes' +%Y-%m-%dT%H:%M:%SZ) \
        --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) \
        --period 60 \
        --statistics Average \
        --region ap-northeast-2 > cpu_result.json
      - python check_cpu.py

  # 8. DB ì»¤ë„¥ì…˜ ëª¨ë‹ˆí„°ë§
  - name: monitor-db
    image: postgres:14
    environment:
      PGHOST: dbhost
      PGUSER: postgres
      PGPASSWORD: dbpassword
    commands:
      - psql -d postgres -c "SELECT numbackends FROM pg_stat_database WHERE datname='postgres';"

  

trigger:
  branch:
    - main
    - feat/drone
    - feat/infra
