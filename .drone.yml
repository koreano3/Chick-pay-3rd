kind: pipeline
type: docker
name: deploy-for-main

steps:
  # 4. ZAP ìë™í™” ìŠ¤ìº” ë‹¨ê³„
  - name: zap-full-automation
    image: appleboy/drone-ssh
    environment:
      ZAP_USERNAME:
        from_secret: ZAP_USERNAME
      ZAP_PASSWORD:
        from_secret: ZAP_PASSWORD
    settings:
      host:
        from_secret: drone_ec2
      username: ubuntu
      key:
        from_secret: drone_ec2_ssh_key
      port: 22

      script:
        - cd /home/ubuntu/zap
        - docker run --rm -v $(pwd):/zap/wrk/:rw --memory=1.5g --cpus=2 ghcr.io/zaproxy/zaproxy:stable zap.sh -cmd -autorun /zap/wrk/zap-automation.yaml
        - |
          echo "ğŸ” JSON ë¦¬í¬íŠ¸ì—ì„œ High ìœ„í—˜ ì´ìƒ ìˆëŠ”ì§€ ê²€ì‚¬ ì¤‘..."
          ERRORS=$(jq '[.site[].alerts[].riskcode | tonumber] | map(select(. >= 3)) | length' reports/zap_report.json)
          if [ "$ERRORS" -gt 0 ]; then
            echo "âŒ High ìœ„í—˜ë„ $ERRORS ê±´ ë°œê²¬ë¨! ë°°í¬ ì¤‘ë‹¨."
            exit 1
          else
            echo "âœ… High ìœ„í—˜ ì—†ìŒ. ê³„ì† ì§„í–‰."
          fi

  # 2. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸, í†µí•© í…ŒìŠ¤íŠ¸ ë‹¨ê³„
  - name: pytest
    image: python:3.12
    environment:
      DJANGO_SETTINGS_MODULE: my_project.settings
    commands:
      - pip install --upgrade pip
      - pip install -r requirements.txt
      - python manage.py migrate
      - pytest

  # 3. Bandit ì •ì  ë¶„ì„ ë‹¨ê³„
  - name: bandit-analysis
    image: python:3.12
    commands:
      - apt-get update && apt-get install -y jq
      - pip install bandit
      - bandit -r core zapp my_project -f json -o analysis/bandit-report.json -x zapp/tests
      - |
        ERRORS=$(jq '.metrics._totals.high + .metrics._totals.medium' analysis/bandit-report.json)
        if [ "$ERRORS" -gt 0 ]; then
          echo "âŒ ë°°í¬ ì¤‘ë‹¨: ë³´ì•ˆ ì·¨ì•½ì ì´ ${ERRORS}ê±´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
          exit 1
        else
          echo "âœ… ë³´ì•ˆ ë¶„ì„ í†µê³¼: ì‹¬ê°í•œ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ê³„ì†í•©ë‹ˆë‹¤."
        fi

  # 5. ë°°í¬ ë‹¨ê³„
  - name: deploy
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: ec2_host
      username: ubuntu
      key:
        from_secret: ssh_private_key
      port: 22
      script:
        - cd /home/ubuntu/Chick-pay-2nd
        - git fetch origin
        - git checkout ${DRONE_BRANCH}
        - git pull origin ${DRONE_BRANCH}
        - docker-compose down
        - docker-compose up -d --build
    timeout: 300

trigger:
  branch:
    - main
    - feat/drone
