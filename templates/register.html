{% extends 'base.html' %}
{% block title %}Chick Pay - íšŒì›ê°€ì…{% endblock %}

{% block content %}
{% load static %}
<div class="bg-white rounded-3xl shadow-lg p-8 max-w-2xl mx-auto border-3 border-chick-yellow">
    <h2 class="text-2xl font-bold text-chick-brown mb-6 text-center">íšŒì›ê°€ì…</h2>

    <form id="register-form">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

            <div class="md:col-span-2">
                <label for="email" class="block mb-2 font-semibold text-gray-600">ì´ë©”ì¼ ID</label>
                <input type="email" id="email" name="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" required
                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
            </div>

            <div>
                <label for="name" class="block mb-2 font-semibold text-gray-600">ì´ë¦„</label>
                <input type="text" id="name" name="name" pattern="^[ê°€-í£a-zA-Z]+$" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required
                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
            </div>

            <div>
                <label for="birthdate" class="block mb-2 font-semibold text-gray-600">ìƒë…„ì›”ì¼</label>
                <input type="text" id="birthdate" name="birthdate" pattern="^\d{4}-\d{2}-\d{2}$"
                    placeholder="ì˜ˆì‹œ 1994-03-05" required
                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
            </div>

            <div>
                <label for="password1" class="block mb-2 font-semibold text-gray-600">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password1" name="password1" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required
                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
            </div>


            <div>
                <label for="password2" class="block mb-2 font-semibold text-gray-600">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="password2" name="password2" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" required
                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
            </div>

            <div class="text-sm font-semibold text-gray-500 mt-3">
                ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.<br>
                ğŸ”‘ ìˆ«ì,ì†Œë¬¸ì,ëŒ€ë¬¸ì ê°ê° 1ê°œ ì´ìƒ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.<br>
            </div>


            <div class="mt-6">
                <div class="flex items-center mb-4">
                    <input type="checkbox" id="terms" required class="mr-2">
                    <label for="terms" class="text-sm text-gray-600">
                        <span class="text-chick-brown font-semibold">ì´ìš©ì•½ê´€</span>ê³¼ <span
                            class="text-chick-brown font-semibold">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</span>ì— ë™ì˜í•©ë‹ˆë‹¤.
                    </label>
                </div>

                <button type="submit"
                    class="w-full bg-chick-yellow text-chick-brown font-bold py-4 px-6 rounded-xl shadow-md hover:bg-chick-orange transition transform hover:-translate-y-0.5 active:translate-y-0">
                    íšŒì›ê°€ì… ì™„ë£Œ
                    <img src="{% static 'images/image.png' %}" alt="Chick Pay" class="w-[18px] h-auto inline">
                </button>
            </div>
    </form>

    <div class="mt-6 text-center">
        <p class="text-gray-600">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="{% url 'login' %}"
                class="text-chick-brown font-semibold hover:underline">ë¡œê·¸ì¸</a></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("register-form");

        form.addEventListener("submit", async function (e) {
            e.preventDefault();

            const payload = {
                name: document.getElementById("name").value,
                email: document.getElementById("email").value,
                birthdate: document.getElementById("birthdate").value,
                password1: document.getElementById("password1").value,
                password2: document.getElementById("password2").value,
            };

            try {
                const response = await fetch("http://127.0.0.1:8001/zapp/api/register/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken"),
                    },
                    body: JSON.stringify(payload),
                });

                const contentType = response.headers.get("content-type");

                if (response.ok) {
                    // ì„±ê³µ ì‹œ JSON ì‘ë‹µì´ë©´ ì½ê³ , ì•„ë‹ˆë©´ ë°”ë¡œ ì´ë™
                    // if (contentType && contentType.includes("application/json")) {
                    //     const result = await response.json();
                    //     // JWT í† í° ì €ì¥
                    //     localStorage.setItem('access_token', result.access_token);
                    //     localStorage.setItem('refresh_token', result.refresh_token);
                    //     alert("âœ… íšŒì›ê°€ì… ì„±ê³µ! OTP ì¸ì¦ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    //     window.location.href = "{% url 'otp-setup' %}";
                    // } else {
                    //     alert("âœ… íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    //     window.location.href = "{% url 'login' %}";
                    // }
                    alert("âœ… íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    window.location.href = "{% url 'login' %}";
                } else {
                    // ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬ (json ë˜ëŠ” html)
                    let errorMessage = "ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                    if (contentType && contentType.includes("application/json")) {
                        const errorData = await response.json();
                        // ì²« ë²ˆì§¸ ì—ëŸ¬ ë©”ì‹œì§€ë§Œ êº¼ë‚´ê¸°
                        if (typeof errorData === "object") {
                            const firstField = Object.keys(errorData)[0];
                            const firstError = errorData[firstField][0];
                            errorMessage = firstError;
                        } else {
                            errorMessage = JSON.stringify(errorData);
                        }
                    } else {
                        const errorText = await response.text();
                        errorMessage = errorText;
                    }
                    alert("â— " + errorMessage);

                }
            } catch (error) {
                alert("ìš”ì²­ ì‹¤íŒ¨: " + error.message);
                console.error("âŒ ìš”ì²­ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error);
            }
        });

        // CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>

{% endblock %}