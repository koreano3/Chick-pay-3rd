name: Deploy to EC2

on:
  push:
    branches:
      - main
      - sub

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout code
        uses: actions/checkout@v3

      - name: ğŸš€ Deploy via SSH to EC2 with Docker + Create .env file
        uses: appleboy/ssh-action@master
        with:
          host: 43.202.96.168
          username: ubuntu
          key: ${{ secrets.ZAPP_SECRET }}
          port: 22
          script: |
            echo "ğŸ“¦ ì´ë™í•´ì„œ ì½”ë“œ ê°±ì‹ "
            cd /home/ubuntu/Chick-pay

            echo "ğŸ” .env ë³µì› ì‹œì‘ (base64 decode)"
            echo "${{ secrets.ENV_FILE }}" | base64 -d > .env

            echo "ğŸ”„ Git pull"
            git pull origin sub

            echo "ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ/ì´ë¯¸ì§€ ì •ë¦¬"
            docker compose down --remove-orphans || true
            docker system prune -af || true

            echo "ğŸ› ï¸ Docker Compose ì¬ë¹Œë“œ (ë‹¤ìš´ ì—†ì´)"
            docker compose up -d --build

            echo "âœ… ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ!"
